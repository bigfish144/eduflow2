<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色生成</title>
    <link rel="stylesheet" href="css/create_char.css">
</head>
<body>
    <!-- 导航栏 -->
    <header class="navbar">
        <button id="back-to-main-btn" class="back-button">
            <img src="images/btn_arrow-right.png" alt="返回" class="back-icon">
            返回工作台
        </button>
        <p class="center-text">角色生成</p>
        <nav class="nav-menu">
        </nav>
    </header>

    <!-- 主内容区域 -->
    <div class="container">
        <!-- 左侧功能区 -->
        <div class="left-section">
            <div class="form-section">
                <label>角色命名</label>
                <input type="text" id="char-name" placeholder="请输入角色名，例如：牛顿"></input>
                <label>素材描述</label>
                <textarea id="char-description" placeholder="请输入描述，例如：一个慈祥的穿着西装的牛顿，卷发"></textarea>
                <div class="select-models">
                    <div class="select-item">
                        <label>选择基础风格</label>
                        <select id="base-style">
                            <option value="3D cartoon style">3D卡通</option>
                            <option value="realistic style">写实风格</option>
                            <option value="anime style">动漫风格</option>
                            <option value="2.5D style">2.5D风格</option>
                        </select>
                    </div>
                    <div class="select-item">
                        <label>选择Lora模型(可选)</label>
                        <select id="lora-model">
                            <option value="null">无</option>
                        </select>
                    </div>
                </div>
                <label>图片尺寸</label>
                <div class="select-size-container">
                    <div class="set-width">
                        <span class="input-label">W</span>
                        <input type="number" id="width" placeholder="宽度" value="512"> 
                    </div>
                    <div class="set-height">
                        <span class="input-label">H</span>
                        <input type="number" id="height" placeholder="高度" value="512"> 
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="transparent-background" checked>
                        <label for="transparent-background">透明背景</label>
                    </div>
                </div>
                <div class="checkbox-container">
                    <div class="checkbox-group">
                        <input type="checkbox" id="import-refimg" checked>
                        <label for="import-refimg">开启参考</label>
                    </div>
                </div>

                <div id="advanced-content">
                    <div class="upload-and-preview-container">
                        <div class="file-upload-container">
                            <label>导入参考图</label>
                            <input type="file" id="file-input" accept="image/*" style="display: none;">
                            <button class="file-upload">
                                <img src="images/btn_add.png" alt="添加" id="add-btn">
                                <label for="file-input" class="upload-label">点击上传</label>
                            </button>
                            <img id="preview-upload-image" src="#" alt="Image Preview" style="display:none; max-width: 280px; margin-top: 10px;">
                        </div>
                        <div class="preview-container">
                            <label>预处理预览</label>
                            <div class="preview-image">
                                <img id="preview-image" alt="预览图像" style="display: none;" />
                                <p id="no-preview" style="color: gray;">暂无预览图像</p>
                            </div>
                        </div>
                    </div>
                    <label>选择参考维度</label>
                    <div class="reference-dimensions">
                        <button class="dimension-btn" data-dimension="edge-outline">边缘轮廓</button>
                        <button class="dimension-btn" data-dimension="character">景深</button>
                        <button class="dimension-btn" data-dimension="pose">人物姿势</button>
                        <button class="dimension-btn" data-dimension="style">风格</button>
                        <button class="dimension-btn" data-dimension="character">角色特征</button>
                    </div>
                    <label>参考权重</label>
                    <span id="weight-value">0.3</span>
                    <div class="slider-container-all">
                        <span>0</span>
                        <div class="slider-container">
                            <div class="slider-track"></div>
                            <input type="range" id="weight-slider" min="0" max="1" step="0.1" value="0.3" />
                        </div>
                        <span>1</span>
                    </div>
                </div>
                <button id="generate-btn" class="primary-btn">生成</button>
            </div>
        </div>

        <!-- 右侧预览区 -->
        <div class="right-section">
            <label>效果图预览</label>
            <div class="preview-grid" id="preview-grid">
            </div>
            <button id="apply-and-return-btn" class="secondary-btn" style="display: none;">应用并返回</button>
        </div>
    </div>

    <!-- 脚本 -->
    <script>
        window.onload = function() {
            //获取lora列表
            const selectElement = document.getElementById('lora-model');
            fetch('/get_lora_list')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.lora_models) {
                        data.lora_models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            selectElement.appendChild(option);
                        });
                    } else {
                        console.error('No lora models found in the response');
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        };
        document.addEventListener('DOMContentLoaded', function() {
            // 开启参考
            const applyandbackToMainBtn = document.getElementById('apply-and-return-btn');
            const importRefImgCheckbox = document.getElementById('import-refimg');
            const advancedContent = document.getElementById('advanced-content');
            importRefImgCheckbox.checked = false;
            advancedContent.style.display = 'none';
            importRefImgCheckbox.addEventListener('change', function() {
                if (importRefImgCheckbox.checked) {
                    advancedContent.style.display = 'block';
                    updateSliderTrack(); 
                } else {
                    advancedContent.style.display = 'none';
                }
            });
            
            // 上传参考图
            document.querySelector('.file-upload').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', function() {
                if (this.files.length > 0) {
                    // 处理文件选择后的逻辑
                    console.log('文件已选择:', this.files[0].name);

                    // 显示预览图像
                    const previewImage = document.getElementById('preview-upload-image');
                    previewImage.src = URL.createObjectURL(this.files[0]);
                    previewImage.style.display = 'block';
                    document.querySelector('.file-upload').style.display = 'none';
                }
            });

            // 权重进度条
            const slider = document.getElementById('weight-slider');
            const weightValue = document.getElementById('weight-value');
            const sliderTrack = document.querySelector('.slider-track');
            function updateSliderTrack() {
                const value = slider.value;
                const width = (value * 100) + '%';
                sliderTrack.style.width = width;
                weightValue.textContent = slider.value;
                // 计算 weight-value 的位置
                const sliderRect = slider.getBoundingClientRect();
                const sliderWidth = sliderRect.width;
                const valuePosition = (value / slider.max) * sliderWidth;
                weightValue.style.left = (valuePosition+180) + 'px';
            }
            slider.addEventListener('input', updateSliderTrack);
            updateSliderTrack();

            //选择维度
            const dimensionButtons = document.querySelectorAll('.dimension-btn');
            dimensionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    dimensionButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            //点击生成按钮
            document.getElementById('generate-btn').addEventListener('click', function() {
                console.log('生成按钮被点击'); 
                // 收集表单数据
                const prompt = document.getElementById('char-description').value;
                const selectedFileName = document.getElementById('char-name').value;
                const baseStyle = document.getElementById('base-style').value;
                const loraModel = document.getElementById('lora-model').value;
                const width = parseInt(document.getElementById('width').value, 10);
                const height = parseInt(document.getElementById('height').value, 10);
                const removebgornot = document.getElementById('transparent-background').checked ? 2 : 1;
                const controlnetornot = document.getElementById('import-refimg').checked ? 2 : 1;
                console.log(prompt,baseStyle,loraModel,width,height,removebgornot,controlnetornot,selectedFileName);
                // 验证所有字段是否为空
                if (!prompt || !baseStyle || !loraModel || !width || !height || !selectedFileName) {
                    alert('请填写全部数据');
                    return; // 停止进一步执行
                }
                // 创建请求体
                const data = {
                    prompt: prompt,
                    selectedFileName: selectedFileName,
                    baseStyle: baseStyle,
                    loraModel: loraModel,
                    width: width,
                    height: height,
                    removebgornot: removebgornot
                };
                //不开启cn
                if (controlnetornot == 1){    
                    console.log('生成图片');           
                    fetch('/generate_img', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.image_url && Array.isArray(data.image_url)) {
                            console.log('Image URLs:', data.image_url);
                            updatePreviewGrid(data.image_url);
                        }
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
                }
                else{
                    console.log('生成图片cn');
                }
            });
            // 更新预览网格
            function updatePreviewGrid(imageUrls) {
                const previewGrid = document.getElementById('preview-grid');
                previewGrid.innerHTML = '';  // 清除现有的预览内容
                applyandbackToMainBtn.style.display = 'block';
                imageUrls.forEach(url => {
                    const previewImageDiv = document.createElement('div');
                    previewImageDiv.className = 'preview-image';
                    const imgElement = document.createElement('img');
                    imgElement.src = url;
                    imgElement.alt = "效果图";
                    imgElement.className = 'preview-image-img';

                    // 为新创建的图片元素添加点击事件监听器
                    imgElement.addEventListener('click', function() {
                        const allPreviewImages = document.querySelectorAll('.preview-image-img');
                        allPreviewImages.forEach(img => img.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    previewImageDiv.appendChild(imgElement);
                    previewGrid.appendChild(previewImageDiv);
                });
            }
            // 应用并返回按钮逻辑
            
            applyandbackToMainBtn.addEventListener('click', function() {
                // 获取选中的图片
                const selectedImage = document.querySelector('.preview-image-img.selected');
                if (!selectedImage) {
                    alert('请先选择一张图片');
                    return;
                }
                const imageUrl = selectedImage.src;
                const charName = document.getElementById('char-name').value;
                if (!charName) {
                    alert('请输入角色名称');
                    return;
                }
                // 发送数据到后端 API
                fetch('/save_gen_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imageUrl: imageUrl, charName: charName })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Image saved successfully:', data.save_filename);
                    window.location.href = 'mainboard.html';
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('保存图片失败，请重试');
                });
            });
        });
    </script>
</body>
</html>