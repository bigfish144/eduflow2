<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduflow</title>
    <link rel="stylesheet" href="static/css/homepage.css">
</head>
<body>
    <div id="fofo" class="fofo-panel">
        <div id="dialog-box" class="dialog-box">
            <p>有什么可以帮助你？</p>
        </div>
        <img id="fofo-image" alt="fofo" src="static/images/FOFO/idle/idle_01.png">
    </div>
    
    <header>
        <div class="logo">
            <img src="static/images/LOGO.png" alt="Eduflows">
        </div>
        <nav>
            <ul>
                <li>
                    <button id="icon-show">徽章墙</button>
                </li>
                <li><a href="https://github.com/bigfish144/eduflow2" target="_blank">Github</a></li>
                <li><a href="https://space.bilibili.com/249505435?spm_id_from=333.1007.0.0" target="_blank">关于我</a></li>
                <li><a href="https://i3sl6nd0ce.feishu.cn/docx/AKcTdaKoJonrNrxiAj7cLCj4nof?from=from_copylink" target="_blank">教程</a></li>
                <li><a href="http://localhost:8000/static/mainboard.html" class="button">工作台</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="hero">
            <h1>欢迎来到<br>Eduflow</h1>
            <p>全流程的开源AI科普视频制作产品</p>
            <div class="line1">
                <img src="static/images/line1.png" alt="line">
            </div>
            <div class="buttons">
                <button id="watch-demo" class="btn-secondary">查看演示</button>
                <button id="start-creation" class="btn-primary">开始创作</button>
            </div>
        </section>
        <div>
            <button class="clear-data" id="clear-data">
                <p>清除数据</p>
            </button>
        </div>
        <section class="features">
            <div class="feature">
                <p><span class="white-text">API</span><br>基于ComfyUI开发</p>
            </div>
            <div class="feature">
                <p><span class="white-text">10+</span><br>多种虚拟人开源项目集合</p>
            </div>
            <div class="feature">
                <p><span class="white-text">100%</span><br>一站式工作流</p>
            </div>
        </section>
        <div class="line2">
            <img src="static/images/line2.png" alt="line">
        </div>

    </main>

    <footer>
        <p>版权所有 &copy; 2024 Eduflow</p>
    </footer>
    <!-- 新面板 -->
    <div class="overlay" id="overlay"></div>
    <div class="new-panel" id="new-panel">
        <div class="panel-header">
            <button id="close-panel" class="close-panel">
                <img src="static/images/btn_back.png" alt="关闭" />
            </button>
            <span >返回</span>
        </div>
        <p class="panel-title">在进入创作之前，您是否有台词文稿？</p>
        <p class="panel-description">选择“是”进入输入文稿界面，否则进入文稿生成页面</p>
        <div class="panel-buttons">
            <button class="btn-primary" id="yes-button">是，进入创作</button>   
        </div>
        <div class="panel-buttons">
            <button class="btn-secondary" id="no-button">否，帮我生成</button>    
        </div>
    </div>
    <!-- 删除数据面板 -->
    <div class="new-panel" id="delete-panel">
        <div class="panel-header">
            <button id="close-panel2" class="close-panel">
                <img src="static/images/btn_back.png" alt="关闭" />
            </button>
            <span >返回</span>
        </div>
        <p class="panel-title">请选择删除数据类型</p>
        <p class="panel-description">所有数据包含本地和ComfyUI，ComfyUI则会保留本地数据</p>
        <div class="panel-buttons">
            <button class="btn-primary" id="delete-all-data">删除所有数据</button>   
        </div>
        <div class="panel-buttons">
            <button class="btn-secondary" id="delete-part-data">仅ComfyUI数据</button>    
        </div>
    </div>
    <!-- 徽章墙面板 -->
    <div class="new-panel" id="icon-panel">
        <div class="panel-header">
            <button id="close-panel3" class="close-panel">
                <img src="static/images/btn_back.png" alt="关闭" />
            </button>
            <span >返回</span>
        </div>
        <p class="panel-title2">徽章墙</p>
        <div class="icon-container">
            <div>
                <img src="static/images/FOFO/huizhang/1.png" alt="徽章1">
                <p>徽章之生成视频</p>
            </div>
            <div>
                <img src="static/images/FOFO/huizhang/2.png" alt="徽章2">
                <p>徽章之生成文稿</p>
            </div>
            <div>
                <img src="static/images/FOFO/huizhang/3.png" alt="徽章3">
                <p>徽章之生成图片</p>
            </div>
            <div>
                <img src="static/images/FOFO/huizhang/4.png" alt="徽章4">
                <p>徽章之生成音频</p>
            </div>
            <div>
                <img src="static/images/FOFO/huizhang/5.png" alt="徽章5">
                <p>徽章之生成动作</p>
            </div>
            <div>
                <img src="static/images/FOFO/huizhang/6.png" alt="徽章6">
                <p>徽章之生成表情</p>
            </div>
            
        </div>
    </div>
    <!-- 查看演示面板 -->
    <div class="new-panel2" id="demovideo-panel">
        <div class="panel-header">
            <button  class="close-panel" id="close-panel4">
                <img src="static/images/btn_back.png" alt="关闭" />
            </button>
            <span >返回</span>
        </div>
        <div class="demovideo-container">
            <video src="static/images/demovideo2.mp4" id="demovideo" style="height: 480px;" controls loop></video>
        </div>
    </div>
    <script>
        //徽章墙面板
        const iconPanel = document.getElementById('icon-panel');
        document.getElementById('icon-show').addEventListener('click', () => {
            iconPanel.style.display = 'block';
        });
        document.getElementById('close-panel3').addEventListener('click', () => {
            iconPanel.style.display = 'none';
        });
        //演示视频面板
        const demovideoPanel = document.getElementById('demovideo-panel');
        document.getElementById('watch-demo').addEventListener('click', () => {
            demovideoPanel.style.display = 'block';
            document.getElementById('demovideo').play();
        });
        document.getElementById('close-panel4').addEventListener('click', () => {
            demovideoPanel.style.display = 'none';
            document.getElementById('demovideo').pause();
        });
        // FOFO桌宠
        // 对话框元素
        const dialogBox = document.getElementById('dialog-box');
        const fofocontainer = document.getElementById('fofo');
        const fofoImage = document.getElementById('fofo-image');
        let currentAnimation = 'idle'; // 当前动画状态，初始为 'idle'
        const animations = ['idle', 'sayhi', 'bound']; // 动画列表
        let animationState = 'idle'; // 动画状态管理
        let sayhiPlayed = false; // 标记 sayhi 动画是否已播放过
        let boundPlayed = false; // 标记 bound 动画是否已播放过

        let idleFrameIndex = 0; // 当前 idle 动画帧索引
        let sayhiFrameIndex = 0; // 当前 sayhi 动画帧索引
        let boundFrameIndex = 0; // 当前 bound 动画帧索引

        const idleFrames = 32; // idle 动画帧数
        const sayhiFrames = 40; // sayhi 动画帧数
        const boundFrames = 35; // bound 动画帧数
        let fps = 125;

        // 启动帧更新
        function startFrameUpdate() {
            setInterval(updateFrame, fps); // 每 125 毫秒更新一次
        }

        function updateFrame() {
            if (animationState === 'sayhi' && !sayhiPlayed) {
                dialogBox.classList.add('visible'); // 添加 visible 类以显示对话框
                fofoImage.src = `static/images/FOFO/sayhi/sayhi_${String(sayhiFrameIndex).padStart(2, '0')}.png`;
                sayhiFrameIndex = (sayhiFrameIndex + 1) % sayhiFrames;
                if (sayhiFrameIndex === 0) {
                    sayhiPlayed = true;
                    console.log('sayhi 动画播放结束');
                    setTimeout(() => {
                        dialogBox.classList.remove('visible'); // 移除 visible 类以隐藏对话框
                        animationState = 'idle';
                        currentAnimation = 'idle';
                        sayhiPlayed = false;
                        idleFrameIndex = 0; 
                    }, 1667); // 延迟重置为 idle 状态
                }
            } else if (animationState === 'bound') {
                fofoImage.src = `static/images/FOFO/bound/bound_${String(boundFrameIndex).padStart(2, '0')}.png`;
                boundFrameIndex = (boundFrameIndex + 1) % boundFrames;
            } else if (animationState === 'idle') {
                fofoImage.src = `static/images/FOFO/idle/idle_${String(idleFrameIndex).padStart(2, '0')}.png`;
                idleFrameIndex = (idleFrameIndex + 1) % idleFrames;
            }
        }

        // 获取屏幕尺寸
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;

        // 初始位置变量
        const initialOffset = 20;

        // 计算并设置初始位置，使用当前图片尺寸（初始为 idle 状态）
        const initialWidth = fofoImage.offsetWidth;
        const initialHeight = fofoImage.offsetHeight;
        fofocontainer.style.top = `${screenHeight - initialHeight - initialOffset}px`;
        fofocontainer.style.left = `${screenWidth - initialWidth - initialOffset}px`;

        let offsetX, offsetY;
        let isDraggable = true; // 默认可拖动
        let isMouseMoved = false; // 标记是否移动鼠标
        let startX, startY; // 记录鼠标起始位置
        const moveThreshold = 50; // 超过 50px 判定为拖动

        // 拖动功能
        fofocontainer.addEventListener('mousedown', (e) => {
            e.preventDefault(); // 禁用默认拖拽行为
            if (isDraggable) {
                startX = e.clientX;
                startY = e.clientY;
                // 用 getBoundingClientRect() 获取精确位置
                const rect = fofocontainer.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                isMouseMoved = false;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
        });

        function onMouseMove(e) {
            isMouseMoved = true;
            if (isDraggable) {
                let newLeft = e.clientX - offsetX;
                let newTop = e.clientY - offsetY;
                // 使用当前图片的尺寸来限制边界
                const currentWidth = fofoImage.offsetWidth;
                const currentHeight = fofoImage.offsetHeight;
                if (newLeft < 0) newLeft = 0;
                if (newTop < 0) newTop = 0;
                if (newLeft + currentWidth > screenWidth) newLeft = screenWidth - currentWidth;
                if (newTop + currentHeight > screenHeight) newTop = screenHeight - currentHeight;
                fofocontainer.style.left = `${newLeft}px`;
                fofocontainer.style.top = `${newTop}px`;
            }
        }

        function onMouseUp(e) {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            // 计算鼠标移动距离
            const moveDistance = Math.sqrt(Math.pow(e.clientX - startX, 2) + Math.pow(e.clientY - startY, 2));
            if (moveDistance > moveThreshold) {
                isMouseMoved = true;
            }
            // 若未移动鼠标，则视为点击操作
            if (!isMouseMoved) {
                const currentIndex = animations.indexOf(currentAnimation);
                currentAnimation = animations[(currentIndex + 1) % animations.length];
                animationState = currentAnimation;
                if (currentAnimation === 'sayhi') {
                    sayhiPlayed = false;
                    sayhiFrameIndex = 0; // 重置 sayhi 帧索引
                } else if (currentAnimation === 'bound') {
                    boundPlayed = false;
                    boundFrameIndex = 0; // 重置 bound 帧索引
                } else if (currentAnimation === 'idle') {
                    idleFrameIndex = 0; // 重置 idle 帧索引
                }
            }
            // 使用当前图片的尺寸计算边界，确保吸附时底部紧贴屏幕底部
            const currentWidth = fofoImage.offsetWidth;
            const currentHeight = fofoImage.offsetHeight;
            let left = parseInt(fofocontainer.style.left, 10);
            let top = parseInt(fofocontainer.style.top, 10);
            const tolerance = 10; // 吸附容差
            let isSticky = false;
            let rotation = 0; 

            if (left < tolerance) {
                fofocontainer.style.left = '0px';
                isSticky = true;
                isDraggable = false;
                rotation = 90;
            } else if (left + currentWidth > screenWidth - tolerance) {
                fofocontainer.style.left = `${screenWidth - currentWidth}px`;
                isSticky = true;
                isDraggable = false;
                rotation = -90; 
            }
            if (top < tolerance) {
                fofocontainer.style.top = '0px';
                isSticky = true;
                isDraggable = false;
                rotation = 180; 
            } else if (top + currentHeight > screenHeight - tolerance) {
                fofocontainer.style.top = `${screenHeight - currentHeight}px`;
                isSticky = true;
                isDraggable = false;
                rotation = 0; 
            }
            // 若吸附到边界，则切换为 bound 动画状态
            if (isSticky) {
                currentAnimation = 'bound';
                animationState = 'bound';
                // 设置旋转角度
                fofoImage.style.transform = `rotate(${rotation}deg)`;
            }
        }

        // 点击时切换动画（避免与拖动冲突）
        fofocontainer.addEventListener('click', function(event) {
            event.preventDefault();
            console.log(currentAnimation);
            if (!isMouseMoved && animationState === 'idle') {
                console.log('sayhiclicked');
                currentAnimation = 'sayhi';
                animationState = 'sayhi';
                sayhiPlayed = false;
                sayhiFrameIndex = 0; // 重置 sayhi 帧索引
            }
        });

        // 双击取消吸附，允许重新拖动
        fofocontainer.addEventListener('dblclick', function() {
            if (!isDraggable) {
                isDraggable = true;
                let newLeft = parseInt(fofocontainer.style.left, 10) + initialOffset;
                let newTop = parseInt(fofocontainer.style.top, 10) + initialOffset;
                fofocontainer.style.left = `${newLeft}px`;
                fofocontainer.style.top = `${newTop}px`;
                currentAnimation = 'idle';
                animationState = 'idle';
                sayhiPlayed = false;
                boundPlayed = false;
                idleFrameIndex = 0; // 重置 帧索引
                sayhiFrameIndex = 0; 
                boundFrameIndex = 0; 
                fofoImage.style.transform = 'rotate(0deg)';
            }
        });
        // 启动帧更新
        startFrameUpdate();
        // 点击按钮显示新面板
        document.getElementById('start-creation').addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('new-panel').style.display = 'block';
        });

        document.getElementById('close-panel').addEventListener('click', function() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('new-panel').style.display = 'none';
        });
        document.getElementById('yes-button').addEventListener('click', function() {
            window.location.href = 'static/textpage.html'; 
        });

        document.getElementById('no-button').addEventListener('click', function() {
            window.location.href = 'static/dialog.html'; 
        });


        //删除数据
        deletepanel=document.getElementById('delete-panel');
        document.getElementById('clear-data').addEventListener('click', function() {
            deletepanel.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        });
        document.getElementById('close-panel2').addEventListener('click', function() {
            document.getElementById('overlay').style.display = 'none';
            deletepanel.style.display = 'none';
        });
        document.getElementById('delete-all-data').addEventListener('click', function() {
            fetch('/clear-folders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "option": "all" 
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.message) {
                    alert("删除成功");  // 弹出成功提示
                    deletepanel.style.display = 'none';  // 隐藏删除面板
                    document.getElementById('overlay').style.display = 'none';  // 隐藏遮罩层
                }
            })
            .catch(error => console.error('Error:', error));
        });
        document.getElementById('delete-part-data').addEventListener('click', function() {
            fetch('/clear-folders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "option": "comfyui" 
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.message) {
                    alert("删除成功");  // 弹出成功提示
                    deletepanel.style.display = 'none';  // 隐藏删除面板
                    document.getElementById('overlay').style.display = 'none';  // 隐藏遮罩层
                }
            })
            .catch(error => console.error('Error:', error));
        });

    </script>
</body>
</html>